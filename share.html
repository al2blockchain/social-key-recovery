<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="assets/vendors/iconfont/material-icons.css">
    <link rel="stylesheet" type="text/css" href="assets/style.css">
    <title>Secrets</title>
</head>
<body>
    <div class="wrapper">
        <header>
            <a href="index.html" class="home"><span class="material-icons">home</span> <span id="home"></span></a>
            <p><span class="logo lock material-icons">lock</span><span class="logo context material-icons">share</span></p>
            <h1 id="shareSecrets"></h1>
        </header>
        <p id="shareSecretsDesc" class="description"></p>
        <form class="form-inline">
            <div class="form-row">
                <label for="secret" id="secretLabel"></label>
                <textarea id="secret" name="secret" required></textarea>
            </div>

            <div class="form-row">
                <label for="persons" id="personsLabel"></label>
                <input type="range" id="persons" name="persons" min="2" max="5" value="2" class="slider">
            </div>
            
            <div class="form-row">
                <label for="requiredPersons" id="requiredPersonsLabel"></label>
                <input type="range" id="requiredPersons" name="requiredPersons" min="2" max="5" value="2" class="slider" >
            </div>
            <div class="center">
                <button id="submit" type="submit"></button>
            </div>
        </form>
        <ol id="shares"></ol>
        <footer>
            <a id="recoverHref" href="recover.html?shares=2"><span class="material-icons flip-horizontal">share</span> <span id="recover"></span></a>
        </footer>
    </div>
    <script src="assets/vendors/secrets.js"></script>
    <script src="assets/i18n.js"></script>
</body>
<script>
    // the shares
    let shares;
    // sliders
    const personsSlider = document.getElementById("persons");
    const requiredPersonsSlider = document.getElementById("requiredPersons");    
    // i18n
    document.title = i18n.title;
    document.getElementById("shareSecrets").innerHTML = i18n.shareSecrets;
    document.getElementById("shareSecretsDesc").innerHTML = i18n.shareSecretsDesc;
    document.getElementById("secretLabel").innerHTML = i18n.secretLabel;
    document.getElementById("personsLabel").innerHTML = `${i18n.persons} ${personsSlider.value}`;
    document.getElementById("requiredPersonsLabel").innerHTML = `${i18n.requiredPersons} ${requiredPersonsSlider.value}`;
    document.getElementById("recover").innerHTML = i18n.recover;
    document.getElementById("home").innerHTML = i18n.home;
    document.getElementById("submit").innerHTML = i18n.share;
    // init the secrets library
    secrets.init();
    // get the form
    const form = document.forms[0];
    // listen for submit
    form.addEventListener("submit", function(event) {
        event.preventDefault();
        new FormData(form);
    });
    // listen for form data
    form.addEventListener("formdata", event => {
        const data = event.formData;
        const values = [...data.values()];
        // get secret
        let secret = values[0], persons, requiredPersons;        
        // get persons and required persons
        try {
            // get persons
            persons = parseInt(values[1]);
            // get requiredPersons
            requiredPersons = parseInt(values[2]);
        } catch (error) {
            alert(error.message);
            return;
        }
        // create the shares
        try {
            shares = secrets.share(secret.hexEncode(), persons, requiredPersons);
            document.getElementById("shares").innerHTML = shares
                .map((share, index) => 
                    `<li id="share-list-element-${index}" class="share-list-element">
                        <input type="text" id="share${index}" value=${share}>
                        <a class="copy" href="#copy" onclick="copy(${index})">Copy <span class="material-icons">done</span></button>
                        <a class="mail" href="mailto:?subject=${i18n.subject}&body=${share}" target="_top">Send Mail</a>
                     </li>`
                ).toString().replace(/,/g, '');
        } catch (error) {
            alert(error.message);
        }
    });
    // observe sliders
    personsSlider.oninput = (event) => {
        event.preventDefault();
        document.getElementById("personsLabel").innerHTML = `${i18n.persons} ${event.target.value}`;
    }
    requiredPersonsSlider.oninput = (event) => {
        event.preventDefault();
        document.getElementById("requiredPersonsLabel").innerHTML = `${i18n.requiredPersons} ${event.target.value}`;
        document.getElementById("recoverHref").href=`recover.html?shares=${event.target.value}`;
    }
    // hex encode function
    String.prototype.hexEncode = function () {
        let hex, i;
        let result = "";
        for (i=0; i<this.length; i++) {
            result += this.charCodeAt(i).toString(16);
        }
        return result;
    }
    function copy (index) {
        // get the input
        const input = document.getElementById(`share${index}`);
        // select it
        input.select();
        // copy
        document.execCommand("copy");
        
        // Remove class from all other items first
        /*
        document.getElementsByClassName('share-list-element').forEach(function( current, index ){
            current.classList.remove("copied")
        }, this );
        */
        // Add class to copied item
        document.getElementById(`share-list-element-${index}`).classList.add("copied");
    }
</script>
</html>